<div class="dashboard-container" *ngIf="!loading">
    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo">TimeClock App</div>
        <div class="user-info">
            <span>Welcome, {{ data?.firstName }} {{ data?.lastName }}</span>
            <button (click)="logout()" class="logout-btn">Logout</button>
        </div>
    </nav>

    <div class="main-content">
        <!-- Controls -->
        <div class="controls-bar">
            <button (click)="changeWeek(-1)" class="nav-btn">&larr; Previous Week</button>
            <span class="week-display">Week of {{ data?.weekSelect | date:'mediumDate' }}</span>
            <button (click)="changeWeek(1)" class="nav-btn">Next Week &rarr;</button>
        </div>

        <!-- Clock In/Out Actions -->
        <div class="action-panel">
            <div class="status-card">
                <h3>Current Status</h3>

                <div *ngIf="findTodayEntry()?.dayStartTime; else noActivity">
                    <!-- User has clocked in at some point today -->
                    <p *ngIf="isClockedIn" class="status-active">Clocked In</p>
                    <p *ngIf="!isClockedIn && findTodayEntry()?.dayEndTime" class="status-inactive">Shift Ended</p>

                    <p class="status-date">{{ findTodayEntry()?.date | date:'fullDate' }}</p>
                    <p>Start Time: {{ formatTime12Hour(findTodayEntry()?.dayStartTime) }}</p>
                    <p>End Time: {{ findTodayEntry()?.dayEndTime ? formatTime12Hour(findTodayEntry()?.dayEndTime) :
                        '--:--' }}</p>
                </div>

                <ng-template #noActivity>
                    <p>Not Clocked In</p>
                    <p class="muted">No activity today</p>
                </ng-template>

                <div class="clock-buttons">
                    <button (click)="clockIn()" class="clock-in-btn" [disabled]="isClockedIn">Clock In</button>
                    <button (click)="clockOut()" class="clock-out-btn" [disabled]="!isClockedIn">Clock Out</button>
                </div>
            </div>

            <!-- Summary Card -->
            <div class="summary-card">
                <h3>Weekly Summary</h3>
                <div class="summary-row">
                    <span>Day Entries:</span>
                    <span>{{ (data?.dayEntryTotalHours || 0) | number:'1.2-2' }} hrs</span>
                </div>
                <div class="summary-row">
                    <span>Task Entries:</span>
                    <span>{{ (data?.taskEntryTotalHours || 0) | number:'1.2-2' }} hrs</span>
                </div>
                <div class="summary-row">
                    <span>Leave Entries:</span>
                    <span>{{ (data?.leaveEntryTotalHours || 0) | number:'1.2-2' }} hrs</span>
                </div>
            </div>
        </div>

        <!-- Day Entries Table -->
        <div class="entries-section">
            <div class="section-header">
                <h3>Day Entries</h3>
            </div>

            <table class="entries-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Duration</th>
                        <th>Comments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let entry of data?.dayEntries">
                        <td>{{ entry.date | date:'shortDate' }}</td>
                        <td>{{ formatTime12Hour(entry.dayStartTime) }}</td>
                        <td>{{ entry.dayEndTime ? formatTime12Hour(entry.dayEndTime) : '--:--' }}</td>
                        <td>{{ entry.workDuration | number:'1.2-2' }}</td>
                        <td>{{ entry.comment }}</td>
                        <td>
                            <button class="icon-btn delete-btn" title="Delete"
                                (click)="deleteDayEntry(entry.id)">&times;</button>
                        </td>
                    </tr>
                    <tr *ngIf="!data?.dayEntries?.length">
                        <td colspan="6" class="no-data">No day entries for this week.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Task Entries Table -->
        <div class="entries-section">
            <div class="section-header">
                <h3>Task Entries</h3>
                <button (click)="toggleAddTaskEntryForm()" class="add-btn">
                    {{ showAddTaskEntryForm ? 'Cancel' : '+ Add Task Entry' }}
                </button>
            </div>

            <!-- Add Task Entry Form -->
            <div *ngIf="showAddTaskEntryForm" class="add-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Job</label>
                        <select [(ngModel)]="newTaskEntry.jobId">
                            <option [ngValue]="null">-- Select Job --</option>
                            <option *ngFor="let job of data?.jobs" [ngValue]="job.id">
                                {{ job.jobNumber }} - {{ job.jobName }}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Task</label>
                        <select [(ngModel)]="newTaskEntry.taskName">
                            <option value="">-- Select Task --</option>
                            <option *ngFor="let task of data?.tasks" [ngValue]="task.taskDescription">
                                {{ task.taskDescription }}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration (hours)</label>
                        <input type="number" [(ngModel)]="newTaskEntry.duration" step="0.25" min="0">
                    </div>
                    <div class="form-group">
                        <label>Comment</label>
                        <input type="text" [(ngModel)]="newTaskEntry.comment" placeholder="Optional comment">
                    </div>
                    <button (click)="addTaskEntry()" class="save-btn">Save</button>
                </div>
            </div>

            <table class="entries-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Job</th>
                        <th>Task</th>
                        <th>Duration</th>
                        <th>Comments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let entry of data?.taskEntries">
                        <td>{{ entry.date | date:'shortDate' }}</td>
                        <td>{{ entry.job?.jobName }}</td>
                        <td>{{ entry.taskName }}</td>
                        <td>{{ entry.duration | number:'1.2-2' }}</td>
                        <td>{{ entry.comment }}</td>
                        <td>
                            <button class="icon-btn delete-btn" title="Delete"
                                (click)="deleteTaskEntry(entry.id)">&times;</button>
                        </td>
                    </tr>
                    <tr *ngIf="!data?.taskEntries?.length">
                        <td colspan="6" class="no-data">No task entries for this week.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Leave Entries Table -->
        <div class="entries-section">
            <div class="section-header">
                <h3>Leave Entries</h3>
                <button (click)="toggleAddLeaveForm()" class="add-btn">
                    {{ showAddLeaveForm ? 'Cancel' : '+ Add Leave Entry' }}
                </button>
            </div>

            <!-- Add Leave Entry Form -->
            <div *ngIf="showAddLeaveForm" class="add-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Leave Type</label>
                        <select [(ngModel)]="newLeaveEntry.leaveType">
                            <option value="PTO">PTO</option>
                            <option value="Sick">Sick</option>
                            <option value="Vacation">Vacation</option>
                            <option value="Personal">Personal</option>
                            <option value="UPTO">Unpaid Time Off</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration (hours)</label>
                        <input type="number" [(ngModel)]="newLeaveEntry.leaveDuration" step="0.5" min="0" max="24">
                    </div>
                    <button (click)="addLeaveEntry()" class="save-btn">Save</button>
                </div>
            </div>

            <table class="entries-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let entry of data?.leaveEntries">
                        <td>{{ entry.date | date:'shortDate' }}</td>
                        <td>{{ entry.leaveType }}</td>
                        <td>{{ entry.leaveDuration }}</td>
                        <td>{{ entry.status }}</td>
                        <td>
                            <button class="icon-btn delete-btn" title="Delete"
                                (click)="deleteLeaveEntry(entry.id)">&times;</button>
                        </td>
                    </tr>
                    <tr *ngIf="!data?.leaveEntries?.length">
                        <td colspan="5" class="no-data">No leave entries for this week.</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- Job & Task Management -->
    <div class="management-section" *ngIf="data?.isAdmin">
        <div class="management-card">
            <div class="section-header">
                <h3>Manage Jobs</h3>
                <button (click)="toggleAddJobForm()" class="add-btn">
                    {{ showAddJobForm ? 'Cancel' : '+ New Job' }}
                </button>
            </div>
            <div *ngIf="showAddJobForm" class="add-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Job Number</label>
                        <input type="text" [(ngModel)]="newJob.jobNumber" placeholder="e.g., 1234">
                    </div>
                    <div class="form-group">
                        <label>Job Name</label>
                        <input type="text" [(ngModel)]="newJob.jobName" placeholder="e.g., Warehouse Upgrade">
                    </div>
                    <button (click)="createJob()" class="save-btn">Save Job</button>
                </div>
            </div>
            <!-- Jobs List -->
            <div class="items-list">
                <div *ngFor="let job of data?.jobs" class="list-item">
                    <span class="item-text">{{ job.jobNumber }} - {{ job.jobName }}</span>
                    <button class="icon-btn delete-btn" title="Delete" (click)="deleteJob(job.id)">&times;</button>
                </div>
                <div *ngIf="!data?.jobs?.length" class="no-data">No jobs available.</div>
            </div>
        </div>
        <div class="management-card">
            <div class="section-header">
                <h3>Manage Tasks</h3>
                <button (click)="toggleAddTaskForm()" class="add-btn">
                    {{ showAddTaskForm ? 'Cancel' : '+ New Task' }}
                </button>
            </div>
            <div *ngIf="showAddTaskForm" class="add-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Task Description</label>
                        <input type="text" [(ngModel)]="newTask.taskDescription" placeholder="e.g., Material Pickup">
                    </div>
                    <button (click)="createTask()" class="save-btn">Save Task</button>
                </div>
            </div>
            <!-- Tasks List -->
            <div class="items-list">
                <div *ngFor="let task of data?.tasks" class="list-item">
                    <span class="item-text">{{ task.taskDescription }}</span>
                    <button class="icon-btn delete-btn" title="Delete" (click)="deleteTask(task.id)">&times;</button>
                </div>
                <div *ngIf="!data?.tasks?.length" class="no-data">No tasks available.</div>
            </div>
        </div>
        <div class="management-card export-card">
            <div class="section-header">
                <h3>Export Time Sheet</h3>
            </div>
            <div class="form-group">
                <label>Select Group</label>
                <select [(ngModel)]="exportForm.group">
                    <option value="" disabled>Select group</option>
                    <option *ngFor="let group of data?.groups" [ngValue]="group">{{ group }}</option>
                </select>
            </div>
            <div class="form-group">
                <label>From</label>
                <input type="date" [(ngModel)]="exportForm.fromDate">
            </div>
            <div class="form-group">
                <label>To</label>
                <input type="date" [(ngModel)]="exportForm.toDate">
            </div>
            <button (click)="exportTimeSheet()" class="add-btn full-width" [disabled]="exporting">
                {{ exporting ? 'Exporting...' : 'Export All Selected' }}
            </button>
        </div>
    </div>
</div>

<div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
</div>
